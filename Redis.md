# Redis

### 部署方式
    * 复制
    * 哨兵
    * 集群
        * 槽指派

### 特征
    * 多样的数据模型（string set list sortedset hash）
        字符串使用的SDS字符串数据对象，包含len和字符数组，比起C原始字符串效率更快
        链表用于列表键
        字典类似HashMap存储（两个数组，分别用于正常访问和扩容复制），通过渐进式rehash实现扩容
        跳跃表
            跳跃向后遍历
            逐个向前遍历
        整数集合
            升级操作
        压缩列表
            连锁更新
    * 持久化
    * 主从同步 master将数据同步到slave，典型分布式读写分离模型
    
### 数据持久化
    * RDB快照（默认） 性能高但容易丢失数据
        * 文件格式包括标识符、数据、校验和
        * SAVE/BGSAVE 阻塞/非阻塞
        * 服务端根据设置条件执行BGSAVE(单位时间的修改数)
    * AOF
        * 保存数据库写命令
        * 先保存至缓冲区，再根据设置值同步到文件
        * 通过读取数据库数据重写AOF文件压缩文件大小
        * 通过重写缓冲区保持重写时的数据一致性
    
### 说明
    * 单进程单线程 利用队列技术将并发访问变为串行访问
    * 通过watch机制实现乐观锁流程
    
### 回收策略
    * 从已设置过期数据中挑选最近最少使用的淘汰
    * 从已设置过期数据中挑选将要过期的淘汰
    * 从已设置过期数据中任意选择数据淘汰
    * 从数据集中挑选最近最少使用的淘汰
    * 从数据集中任意选择数据淘汰
    * 禁止驱逐数据(默认)

### 过期删除策略
* 定时删除 给key建立定时器，到达时间删除
* 被动删除 调用key值判断删除
* 定期删除 定时任务检测到时间删除
    
### 核心对象
    
    redisObject
    type encoding vm ptr
    
    根据不同数据类型大小选择不同的数据结构存储（命令多态），ptr指向数据内容。
    通过计数实现对象回收，通过共享对象节约内存
    
    redisServer -> redisDb -> dict（正常键空间+过期键空间）
    
### 处理命令逻辑

    * 事件分为文件事件和时间事件
    * 时间事件主要是serverCron时间，负责数据库统计信息、RDB/AOF写入、清理过期数据、主从同步等
    * 时间事件和文件事件的协调执行（根据最接近的时间事件阻塞等待文件事件保证调度的高校）

    1. 从多路复用框架中select出已经ready的文件描述符（ready标准是已到达内核、已准备写入数据）
    2. 对每个文件描述符已准备的事件进行处理，处理完相同文件描述符的事件后，再处理下一个（事件类型分为连接请求、请求命令、将暂存的执行结果写回客户端）
    3. 客户端命令执行结束后，处理定时任务
    4. 本次循环完毕，进入下一次循环的beforeSleep逻辑（处理数据过期、持久化写入等任务）
    
### 功能
    * 发布订阅
    * 事务
        依靠watch监听变化判断是否执行exec
    * LUA脚本执行
    * 排序
        内部通过数组结构排序实现
    * 二进制位操作
        逆序数组保证setbit高效，bitcount采用SWAR位运算及查表算法保证高效
    * 慢查询日志、监视器
        slowlog、monitor